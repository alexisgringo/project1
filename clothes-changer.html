<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Color Changer ‚Äî Lex</title>
  <style>
    :root{--bg1:#0f172a;--bg2:#0b1220;--card:#0b1226;--accent:#7c5cff;--muted:#9aa4bf;--text:#e6eef8}
    body.light-theme {
      --bg1:#f5f5f7;--bg2:#ffffff;--card:#ffffff;--accent:#7c5cff;--muted:#6b7280;--text:#1f2937;
    }
    body.auto-theme {
      color-scheme: light dark;
    }
    *{box-sizing:border-box}
    body{min-height:100vh;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:var(--text);padding:20px}
    .header{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto 30px;padding:0 28px}
    .brand-header{display:flex;align-items:center;gap:10px}
    .logo{width:40px;height:40px;border-radius:10px;display:inline-grid;place-items:center;background:linear-gradient(135deg,#fff2 0%,#ffffff05 100%);color:var(--accent);font-weight:700}
    .nav-links{display:flex;gap:24px}
    .nav-links a{color:var(--muted);text-decoration:none;font-size:14px;transition:color .2s}
    .nav-links a:hover{color:var(--text)}
    .nav-links a.active{color:var(--accent);border-bottom:2px solid var(--accent);padding-bottom:4px}
    .container{max-width:1200px;margin:0 auto}
    h1{margin:0 0 8px;font-size:28px}
    .subtitle{color:var(--muted);font-size:14px;margin:0 0 30px}
    .editor-container{display:grid;grid-template-columns:1fr 300px;gap:30px}
    .canvas-wrapper{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:24px;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    body.light-theme .canvas-wrapper{background:linear-gradient(180deg,rgba(0,0,0,0.02),rgba(0,0,0,0.01));box-shadow:0 8px 30px rgba(0,0,0,0.1);border-color:rgba(0,0,0,0.06)}
    #canvas{border:2px solid rgba(124,92,255,0.3);border-radius:10px;display:block;background:#fff;cursor:crosshair}
    #canvas.selection-mode{cursor:crosshair}
    .btn.active{background:linear-gradient(90deg,var(--accent),#5aa0ff);color:#081126}
    .btn.active.secondary{background:linear-gradient(90deg,var(--accent),#5aa0ff);color:#081126;border-color:transparent}
    .controls{display:flex;flex-direction:column;gap:20px}
    .control-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:20px;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.04)}
    body.light-theme .control-card{background:linear-gradient(180deg,rgba(0,0,0,0.02),rgba(0,0,0,0.01));box-shadow:0 8px 30px rgba(0,0,0,0.1);border-color:rgba(0,0,0,0.06)}
    .control-card h3{margin:0 0 12px;font-size:14px;color:var(--text);font-weight:600}
    .control-group{display:flex;flex-direction:column;gap:8px}
    .control-label{font-size:12px;color:var(--muted)}
    input[type="range"]{width:100%;height:6px;border-radius:3px;background:rgba(255,255,255,0.1);outline:none;-webkit-appearance:none}
    input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}
    input[type="range"]::-moz-range-thumb{width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;border:none}
    input[type="color"]{width:100%;height:40px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);cursor:pointer}
    input[type="file"]{display:none}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#5aa0ff);color:#081126;font-weight:600;cursor:pointer;transition:transform .12s,filter .12s;font-size:13px;width:100%;text-decoration:none;gap:8px}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04)}
    .btn.secondary:hover{color:#e6eef8;border-color:rgba(255,255,255,0.08)}
    .loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,rgba(15,23,42,0.95),rgba(11,18,32,0.95));display:none;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(8px)}
    .loading-overlay.show{display:flex}
    .loading-container{text-align:center;animation:fadeInScale .4s cubic-bezier(.2,.9,.3,1) both}
    @keyframes fadeInScale{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
    .loading-text{font-size:48px;font-weight:700;color:var(--accent);margin:0 0 24px;letter-spacing:2px;animation:pulse 1s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.05);opacity:.8}}
    .loading-dots{font-size:32px;color:var(--accent);letter-spacing:8px;animation:blink 1.4s infinite}
    @keyframes blink{0%,20%,50%,80%,100%{opacity:1}40%{opacity:.3}60%{opacity:.3}}
    .info-text{font-size:12px;color:var(--muted);margin-top:8px}
    /* responsive */
    @media (max-width:768px){
      .editor-container{grid-template-columns:1fr}
      .header{flex-direction:column;gap:20px}
      .nav-links{gap:12px}
    }
    /* footer */
    footer{position:fixed;bottom:0;left:0;right:0;background:rgba(11,18,32,0.8);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,0.04);padding:16px 28px;text-align:center;z-index:100}
    body.light-theme footer{background:rgba(245,245,247,0.8)}
    .footer-content{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:8px;font-size:12px;color:var(--muted)}
    .footer-links{display:flex;justify-content:center;gap:16px}
    .footer-links a{color:var(--accent);text-decoration:none;transition:color .2s}
    .footer-links a:hover{color:#5aa0ff}
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-container">
      <div class="loading-text">LOADING!!!!</div>
      <div class="loading-dots">‚óè‚óè‚óè</div>
    </div>
  </div>
  <div class="header">
    <div class="brand-header">
      <div class="logo">Lx</div>
      <h2 style="margin:0;font-size:20px;color:var(--text)">Lex</h2>
    </div>
    <nav class="nav-links">
      <a href="#" onclick="showLoadingAndNavigate('index.html')">Home</a>
      <a href="#" onclick="showLoadingAndNavigate('settings.html')">Settings</a>
      <a href="#" onclick="handleSignOut(event)">Sign out</a>
    </nav>
  </div>

  <div class="container">
    <h1>Color Changer</h1>
    <p class="subtitle">Change the color of any element in your images</p>

    <div class="editor-container">
      <div class="canvas-wrapper">
        <canvas id="canvas"></canvas>
      </div>

      <div class="controls">
        <div class="control-card">
          <h3>Image Upload</h3>
          <button class="btn secondary" onclick="document.getElementById('imageInput').click()">üìÅ Upload Image</button>
          <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)">
          <p class="info-text">Upload a photo with clothes to recolor</p>
        </div>

        <div class="control-card">
          <h3>Selection</h3>
          <button class="btn secondary" id="selectionBtn" onclick="toggleSelectionMode()" style="margin-bottom:12px">üéØ Select Area</button>
          <button class="btn secondary" onclick="clearSelection()" style="margin-bottom:8px">Clear Selection</button>
          <p class="info-text" id="selectionInfo">Draw a rectangle to select area</p>
        </div>

        <div class="control-card">
          <h3>Color Selection</h3>
          <div class="control-group">
            <label class="control-label">Select Color</label>
            <input type="color" id="clothesColor" value="#ff0000">
          </div>
          <div class="control-group">
            <label class="control-label">Tolerance</label>
            <input type="range" id="tolerance" min="10" max="100" value="50">
          </div>
          <button class="btn secondary" onclick="changeClothesColor()" style="margin-top:12px">üé® Apply Color</button>
        </div>

        <div class="control-card">
          <h3>Actions</h3>
          <button class="btn secondary" onclick="resetImage()">Reset Image</button>
          <button class="btn" onclick="downloadImage()" style="margin-top:8px">üì• Download</button>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="footer-content">
      <p style="margin:0">¬© 2026 Lex. All rights reserved.</p>
      <div class="footer-links">
        <a href="https://wa.me/250729450139" target="_blank" title="WhatsApp">WhatsApp</a>
        <a href="https://facebook.com" target="_blank" title="Facebook">Facebook</a>
        <a href="tel:+250729450139" title="Phone">+250729450139</a>
      </div>
    </div>
  </footer>

  <script>
    function loadTheme() {
      const theme = localStorage.getItem('theme') || 'dark';
      if(theme !== 'dark') {
        document.body.className = theme + '-theme';
      }
    }
    loadTheme();

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const clothesColor = document.getElementById('clothesColor');
    const tolerance = document.getElementById('tolerance');
    let originalImage = null;
    let selectionMode = false;
    let isDrawing = false;
    let startX = 0;
    let startY = 0;
    let selection = null;

    canvas.width = 600;
    canvas.height = 400;

    function initCanvas() {
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#9aa4bf';
      ctx.font = '14px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('Upload an image to get started', canvas.width / 2, canvas.height / 2);
    }

    function handleImageUpload(event) {
      const file = event.target.files[0];
      if(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            originalImage = img;
            const maxWidth = 600;
            const maxHeight = 400;
            let width = img.width;
            let height = img.height;

            if(width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            if(height > maxHeight) {
              width = (width * maxHeight) / height;
              height = maxHeight;
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            selection = null;
            updateSelectionInfo();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    function toggleSelectionMode() {
      selectionMode = !selectionMode;
      document.getElementById('selectionBtn').classList.toggle('active', selectionMode);
      canvas.classList.toggle('selection-mode', selectionMode);
      if(selectionMode) {
        document.getElementById('selectionInfo').textContent = 'üìç Draw a rectangle on the image';
      } else {
        document.getElementById('selectionInfo').textContent = 'üéØ Selection disabled';
      }
    }

    function clearSelection() {
      selection = null;
      selectionMode = false;
      document.getElementById('selectionBtn').classList.remove('active');
      canvas.classList.remove('selection-mode');
      updateSelectionInfo();
      if(originalImage) {
        resetImage();
      }
    }

    function updateSelectionInfo() {
      const info = document.getElementById('selectionInfo');
      if(selection) {
        const w = Math.abs(selection.x2 - selection.x1);
        const h = Math.abs(selection.y2 - selection.y1);
        info.textContent = `‚úì Selected: ${Math.round(w)}x${Math.round(h)} pixels`;
      } else if(selectionMode) {
        info.textContent = 'üìç Draw a rectangle on the image';
      } else {
        info.textContent = 'Draw a rectangle to select area';
      }
    }

    canvas.addEventListener('mousedown', (e) => {
      if(!selectionMode || !originalImage) return;
      isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;
    });

    canvas.addEventListener('mousemove', (e) => {
      if(!isDrawing || !selectionMode) return;
      const rect = canvas.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;

      // Redraw image
      ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);

      // Draw selection rectangle
      ctx.strokeStyle = 'rgba(124, 92, 255, 0.8)';
      ctx.lineWidth = 2;
      ctx.fillStyle = 'rgba(124, 92, 255, 0.1)';
      const width = currentX - startX;
      const height = currentY - startY;
      ctx.fillRect(startX, startY, width, height);
      ctx.strokeRect(startX, startY, width, height);
    });

    canvas.addEventListener('mouseup', (e) => {
      if(!isDrawing || !selectionMode) return;
      isDrawing = false;
      const rect = canvas.getBoundingClientRect();
      const endX = e.clientX - rect.left;
      const endY = e.clientY - rect.top;

      selection = {
        x1: Math.min(startX, endX),
        y1: Math.min(startY, endY),
        x2: Math.max(startX, endX),
        y2: Math.max(startY, endY)
      };

      // Redraw with selection box
      ctx.drawImage(originalImage, 0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = 'rgba(124, 92, 255, 0.8)';
      ctx.lineWidth = 2;
      ctx.fillStyle = 'rgba(124, 92, 255, 0.1)';
      ctx.fillRect(selection.x1, selection.y1, selection.x2 - selection.x1, selection.y2 - selection.y1);
      ctx.strokeRect(selection.x1, selection.y1, selection.x2 - selection.x1, selection.y2 - selection.y1);

      selectionMode = false;
      document.getElementById('selectionBtn').classList.remove('active');
      canvas.classList.remove('selection-mode');
      updateSelectionInfo();
    });

    function changeClothesColor() {
      if(!originalImage) {
        alert('Please upload an image first');
        return;
      }

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const color = clothesColor.value;
      const tol = tolerance.value;

      // Convert hex color to RGB
      const r = parseInt(color.substring(1, 3), 16);
      const g = parseInt(color.substring(3, 5), 16);
      const b = parseInt(color.substring(5, 7), 16);

      // Convert RGB to HSL for better color matching
      function rgbToHsl(r, g, b) {
        r /= 255;
        g /= 255;
        b /= 255;
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;

        if(max === min) {
          h = s = 0;
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch(max) {
            case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
            case g: h = ((b - r) / d + 2) / 6; break;
            case b: h = ((r - g) / d + 4) / 6; break;
          }
        }
        return [h, s, l];
      }

      // Convert HSL back to RGB
      function hslToRgb(h, s, l) {
        let r, g, b;
        if(s === 0) {
          r = g = b = l;
        } else {
          const hue2rgb = (p, q, t) => {
            if(t < 0) t += 1;
            if(t > 1) t -= 1;
            if(t < 1/6) return p + (q - p) * 6 * t;
            if(t < 1/2) return q;
            if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
            return p;
          };
          const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          const p = 2 * l - q;
          r = hue2rgb(p, q, h + 1/3);
          g = hue2rgb(p, q, h);
          b = hue2rgb(p, q, h - 1/3);
        }
        return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
      }

      // Get target color HSL
      const targetHsl = rgbToHsl(r, g, b);
      const toleranceRange = tol / 100;

      // Process each pixel
      for(let i = 0; i < data.length; i += 4) {
        const pixelIndex = i / 4;
        const pixelX = pixelIndex % canvas.width;
        const pixelY = Math.floor(pixelIndex / canvas.width);

        // Check if pixel is in selection (if selection exists)
        let inSelection = true;
        if(selection) {
          if(pixelX < selection.x1 || pixelX > selection.x2 || pixelY < selection.y1 || pixelY > selection.y2) {
            continue;
          }
          inSelection = true;
        }

        const pixelR = data[i];
        const pixelG = data[i+1];
        const pixelB = data[i+2];
        const alpha = data[i+3];

        // Convert pixel to HSL
        const [pixelH, pixelS, pixelL] = rgbToHsl(pixelR, pixelG, pixelB);

        // Calculate hue difference (circular)
        let hueDiff = Math.abs(pixelH - targetHsl[0]);
        if(hueDiff > 0.5) hueDiff = 1 - hueDiff;

        // Different logic for selected area vs whole image
        let shouldChange = false;
        if(selection) {
          // In selected area: apply stronger color change with more lenient tolerance
          shouldChange = hueDiff < toleranceRange * 0.5 || pixelS < 0.1;
        } else {
          // For whole image: use strict hue matching
          shouldChange = hueDiff < toleranceRange * 0.3;
        }

        if(shouldChange) {
          // Preserve saturation and apply new hue with original lightness
          const newRgb = hslToRgb(targetHsl[0], pixelS, pixelL);
          data[i] = newRgb[0];
          data[i+1] = newRgb[1];
          data[i+2] = newRgb[2];
        }
      }

      ctx.putImageData(imageData, 0, 0);

      // Redraw selection if it exists
      if(selection) {
        ctx.strokeStyle = 'rgba(124, 92, 255, 0.8)';
        ctx.lineWidth = 2;
        ctx.fillStyle = 'rgba(124, 92, 255, 0.1)';
        ctx.fillRect(selection.x1, selection.y1, selection.x2 - selection.x1, selection.y2 - selection.y1);
        ctx.strokeRect(selection.x1, selection.y1, selection.x2 - selection.x1, selection.y2 - selection.y1);
      }
    }

    function resetImage() {
      if(originalImage) {
        const maxWidth = 600;
        const maxHeight = 400;
        let width = originalImage.width;
        let height = originalImage.height;

        if(width > maxWidth) {
          height = (height * maxWidth) / width;
          width = maxWidth;
        }
        if(height > maxHeight) {
          width = (width * maxHeight) / height;
          height = maxHeight;
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(originalImage, 0, 0, width, height);
      } else {
        initCanvas();
      }
    }

    function downloadImage() {
      const link = document.createElement('a');
      link.href = canvas.toDataURL('image/png');
      link.download = 'clothes-changed-' + new Date().getTime() + '.png';
      link.click();
    }

    function showLoadingAndNavigate(url) {
      document.getElementById('loadingOverlay').classList.add('show');
      setTimeout(() => {
        window.location.href = url;
      }, 3000);
    }

    function handleSignOut(e) {
      e.preventDefault();
      showLoadingAndNavigate('lex.html');
    }

    initCanvas();
  </script>
</body>
</html>
